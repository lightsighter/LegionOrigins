\lstset{
  language=C++,
  basicstyle=\scriptsize,
  numbers=left,
  numberstyle=\tiny,
  stepnumber=1,
  escapechar=\#,
  keepspaces=true,
  morekeywords={region_relation,region,coloring,partition},
  deletekeywords=float,
}
\begin{lstlisting}[float]
struct Node<rn>    { Node<rn>@rn next;    float charge, capacitance; }
struct Wire<rn,rn2,rw> { Wire<rn,rn2,rw>@rw next; Node<rn2>@rn in_node, out_node; float current, ... ; }
region_relation Circuit {
  region< Node<r_all_nodes> >                r_all_nodes;
  region< Wire<r_all_nodes,r_all_wires> >    r_all_wires;
  Node<r_all_nodes>@r_all_nodes              first_node;
  Wire<r_all_nodes,r_all_wires>@r_all_wires  first_wire;
}
region_relation CircuitPiece<rn, rw> {
  region< Node<rn_pvt+rn_shr> >                    rn_pvt (< rn), rn_shr (< rn);
  region< Node<rn> >                               rn_ghost (< rn);
  region< Wire<rn_pvt+rn_shr+rn_ghost,rn,rw_pvt> > rw_pvt (< rw);
  Node<rn_pvt+rn_shr>@(rn_pvt+rn_shr)              first_node;
  Wire<rn_pvt+rn_shr+rn_ghost,rn,rw_pvt>@rw_pvt    first_wire;
};
void simulate_circuit(Circuit c) : RWE(c.r_all_nodes,c.r_all_wires)
{
  coloring<c.r_all_wires> wire_owner_map = ... ; // wires colored by which piece they're in
  partition<c.r_all_wires> p_wires = partition(c.r_all_wires, wire_owner_map);
  coloring<c.r_all_nodes> node_owner_map = ... ; // nodes colored by which piece they're in
  coloring<c.r_all_wires> node_nghbr_map = ... ; // nodes colored by which pieces they neigbor
  coloring<c.r_all_wires> node_privacy_map = ... ; // nodes colored: 0 = no neighbors, 1 = some neighbors
  partition<c.r_all_nodes> p_nodes_pvs = partition(c.r_all_nodes, node_privacy_map);
  partition<p_nodes_pvs[0]> p_pvt_nodes = partition(p_nodes_pvs[0], node_owner_map);
  partition<p_nodes_pvs[1]> p_shr_nodes = partition(p_nodes_pvs[1], node_owner_map);
  partition<p_nodes_pvs[1]> p_ghost_nodes = partition(p_nodes_pvs[1], node_nghbr_map);

  CircuitPiece<c.r_all_nodes,c.r_all_wires> pieces[MAX_PIECES];
  for(i = 0; i < MAX_PIECES; i++) 
    pieces[i] <- { rn_pvt = p_pvt_nodes[i], rn_shr = p_shr_nodes[i],
                   rn_ghost = p_ghost_nodes[i], rw_pvt = p_wires[i] };

  while(!done) {
    for(i = 0; i < MAX_PIECES; i++) spawn(calc_new_currents(pieces[i]));
    for(i = 0; i < MAX_PIECES; i++) spawn(distribute_charge(pieces[i]));
    for(i = 0; i < MAX_PIECES; i++) spawn(update_voltages(pieces[i]));
  }
}

void calc_new_currents(CircuitPiece<rn,rw> piece): RWE(piece.rw_pvt), ROE(piece.rn_pvt,piece.rn_shr,piece.rn_ghost) {
  // read info from nodes connected to each wire, update state of wire
}

void distribute_charge(CircuitPiece<rn,rw> piece): ROE(piece.rw_pvt), RdA(piece.rn_pvt,piece.rn_shr,piece.rn_ghost) {
  // current moving through wires redistributes charge between nodes
}

void update_voltages(CircuitPiece<rn,rw> piece): RWE(piece.rn_pvt,piece.rn_shr)
{
  // total charge added to a node causes changes in voltage
}
\end{lstlisting}
