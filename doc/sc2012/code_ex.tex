\lstset{
  captionpos=b,
  language=C++,
  basicstyle=\scriptsize,
  numbers=left,
  numberstyle=\tiny,
  columns=fullflexible,
  stepnumber=1,
  escapechar=\#,
  keepspaces=true,
  literate={<}{{$\langle$}}1 {>}{{$\rangle$}}1,
  morekeywords={region,coloring,partition,spawn,disjoint,aliased},
  deletekeywords=float,
}
\begin{lstlisting}[float={t},label={lst:code_ex},caption={Circuit Simulation Code Example}]
struct Node { float charge, capacitance; };
struct Wire { Node in_node, out_node; float current, ... ; };
struct Circuit {
  region   r_all_nodes;
  region   r_all_wires; };

struct CircuitPiece {
  region  rn_pvt, rn_shr, rn_ghost; // private, shared, ghost node regions
  region  rw_pvt;                   // private wires region };

void simulate_circuit(Circuit c) : RWE(c.r_all_nodes,c.r_all_wires)
{
  // Partition of wires into pieces
  partition<disjoint> p_wires = c.r_all_wires.partition(wire_owner_map); 
  // Partition nodes into two parts for all-private vs. all-shared
  partition<disjoint> p_nodes_pvs = c.r_all_nodes.partition(node_sharing map);

  // Partition all-private into separate circuit pieces
  partition<disjoint> p_pvt_nodes = p_nodes_pvs[0].partition(node_owner_map);
  // Partition all-shared into separate circuit pieces
  partition<disjoint> p_shr_nodes = p_nodes_pvs[1].partition(node_owner_map);
  // Partition all-shared into ghost regions which may be aliased
  partition<aliased> p_ghost_nodes = p_nodes_pvs[1].partition(node_neighbor_map);

  CircuitPiece pieces[MAX_PIECES];
  for(i = 0; i #$<$# MAX_PIECES; i++) 
    pieces[i] = { rn_pvt: p_pvt_nodes[i], rn_shr: p_shr_nodes[i],
                  rn_ghost: p_ghost_nodes[i], rw_pvt: p_wires[i] };
  while(!done) {
    spawn (i = 0; i #$<$# MAX_PIECES; i++) calc_new_currents(pieces[i]);
    spawn (i = 0; i #$<$# MAX_PIECES; i++) distribute_charge(pieces[i]);
    spawn (i = 0; i #$<$# MAX_PIECES; i++) update_voltages(pieces[i]);
  }
}

// read info from nodes connected to each wire, update state of wire
void calc_new_currents(CircuitPiece piece): RWE(piece.rw_pvt),
                                            ROE(piece.rn_pvt,piece.rn_shr,piece.rn_ghost)
// current moving through wires redistributes charge between nodes
void distribute_charge(CircuitPiece piece): ROE(piece.rw_pvt),
                                            RWE(piece.rn_pvt),
                                            RdA(piece.rn_shr,piece.rn_ghost)
// total charge added to a node causes changes in voltage
void update_voltages(CircuitPiece piece): RWE(piece.rn_pvt,piece.rn_shr)
\end{lstlisting}
